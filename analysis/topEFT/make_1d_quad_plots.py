import os
import numpy as np
import matplotlib.pyplot as plt
from coffea.nanoevents import NanoEventsFactory

import topcoffea.modules.fileReader as fr
import topcoffea.modules.QuadFitTools as qft
from topcoffea.plotter.make_html import make_html


def main():

    # Open an example file
    redirector = "root://deepthought.crc.nd.edu/"
    in_file = "/store/user/kmohrman/FullProduction/FullR2/UL17/Round1/Batch2/naodOnly_step/v2/nAOD_step_ttHJet_all22WCsStartPtCheckdim6TopMay20GST_run0/NAOD-00000_10769.root"
    in_file = redirector + in_file

    # Get the events object and wc names from the input file
    events = NanoEventsFactory.from_root(in_file).events()
    wc_names_lst = fr.GetListOfWCs(in_file)

    # Get the wc fit dict
    wc_fit_arr = qft.get_summed_quad_fit_arr(events)
    wc_fit_dict = qft.get_quad_fit_dict(wc_names_lst,wc_fit_arr)

    # An example fit dictionary
    #wc_fit_dict = {'sm*sm': 533.7265014648438, 'cpt*sm': 0.2774582505226135, 'cpt*cpt': 0.31988057494163513, 'ctp*sm': -65.5294418334961, 'ctp*cpt': -0.11444121599197388, 'ctp*ctp': 2.0598204135894775, 'cptb*sm': 2.8727339440592914e-07, 'cptb*cpt': 2.7710587602314263e-08, 'cptb*ctp': 7.791592224748456e-07, 'cptb*cptb': 0.20044660568237305, 'cQlMi*sm': -6.755139025926837e-08, 'cQlMi*cpt': -3.6283538396020276e-09, 'cQlMi*ctp': 7.078867270138289e-08, 'cQlMi*cptb': 3.92220389500153e-09, 'cQlMi*cQlMi': 1.1094011126422387e-10, 'cQq81*sm': 39.27901077270508, 'cQq81*cpt': 0.0020306576043367386, 'cQq81*ctp': -2.4044852256774902, 'cQq81*cptb': 2.7672615487972507e-07, 'cQq81*cQlMi': 5.293017579788284e-08, 'cQq81*cQq81': 18.173954010009766, 'cQq11*sm': -0.4944908916950226, 'cQq11*cpt': -0.22110173106193542, 'cQq11*ctp': 0.0676933154463768, 'cQq11*cptb': -7.107773853931576e-07, 'cQq11*cQlMi': 6.834186194737413e-08, 'cQq11*cQq81': -6.615614414215088, 'cQq11*cQq11': 107.09120178222656, 'cQl3i*sm': 6.567980648242155e-08, 'cQl3i*cpt': -6.667961738315853e-09, 'cQl3i*ctp': -3.741104137588991e-08, 'cQl3i*cptb': -9.763299502196787e-09, 'cQl3i*cQlMi': 9.116807309084152e-10, 'cQl3i*cQq81': -6.339561053891885e-08, 'cQl3i*cQq11': 1.7991875722600525e-07, 'cQl3i*cQl3i': 1.6241663569616094e-09, 'ctq8*sm': 42.544654846191406, 'ctq8*cpt': -0.007176943123340607, 'ctq8*ctp': -2.6041855812072754, 'ctq8*cptb': -1.3343444038582675e-07, 'ctq8*cQlMi': -6.205754132793118e-09, 'ctq8*cQq81': 12.929119110107422, 'ctq8*cQq11': 0.03668104484677315, 'ctq8*cQl3i': -1.596924050772941e-07, 'ctq8*ctq8': 21.049339294433594, 'ctlTi*sm': 5.73712544138516e-09, 'ctlTi*cpt': -6.299876620374789e-09, 'ctlTi*ctp': -1.5723821888968814e-07, 'ctlTi*cptb': -6.096838145452921e-09, 'ctlTi*cQlMi': 1.1288626283745273e-10, 'ctlTi*cQq81': 1.0440174946779734e-07, 'ctlTi*cQq11': -3.881307009123702e-08, 'ctlTi*cQl3i': -3.8899197751796066e-10, 'ctlTi*ctq8': -8.379041815942401e-08, 'ctlTi*ctlTi': 1.174266933690049e-10, 'ctq1*sm': 7.769176959991455, 'ctq1*cpt': -0.10611292719841003, 'ctq1*ctp': -0.5088086724281311, 'ctq1*cptb': -1.5783918172473932e-07, 'ctq1*cQlMi': 2.142702157925669e-07, 'ctq1*cQq81': 0.036675963550806046, 'ctq1*cQq11': 63.012508392333984, 'ctq1*cQl3i': 8.339772961107883e-08, 'ctq1*ctq8': 7.350154876708984, 'ctq1*ctlTi': -2.715709257472554e-08, 'ctq1*ctq1': 108.10565185546875, 'ctli*sm': 7.415188019166408e-09, 'ctli*cpt': -2.6707851485952006e-09, 'ctli*ctp': 8.518819072378392e-08, 'ctli*cptb': 9.378867682485748e-10, 'ctli*cQlMi': 2.6391250296242674e-10, 'ctli*cQq81': -2.9373854459890936e-08, 'ctli*cQq11': 1.4341182463795121e-08, 'ctli*cQl3i': -4.055921709600341e-10, 'ctli*ctq8': -5.41099876016915e-09, 'ctli*ctlTi': -3.39827527229275e-10, 'ctli*ctq1': 1.8264506707055261e-07, 'ctli*ctli': -1.6257569734889898e-09, 'cQq13*sm': 10.450677871704102, 'cQq13*cpt': -1.5661274194717407, 'cQq13*ctp': -0.4300411343574524, 'cQq13*cptb': -8.980457266716257e-08, 'cQq13*cQlMi': -8.083597435870615e-08, 'cQq13*cQq81': -1.6037293672561646, 'cQq13*cQq11': 53.08015441894531, 'cQq13*cQl3i': 8.804607887213933e-08, 'cQq13*ctq8': -0.00998491421341896, 'cQq13*ctlTi': 2.748360827808938e-07, 'cQq13*ctq1': 13.681410789489746, 'cQq13*ctli': 1.5331137248608684e-08, 'cQq13*cQq13': 107.09120178222656, 'cbW*sm': -3.624587918693578e-07, 'cbW*cpt': 5.4542550032010695e-08, 'cbW*ctp': -1.3887478189644753e-07, 'cbW*cptb': -0.01930350810289383, 'cbW*cQlMi': -1.9608346057964354e-09, 'cbW*cQq81': -1.3950204902357655e-06, 'cbW*cQq11': -1.9653728031698847e-06, 'cbW*cQl3i': -1.1090351748066496e-08, 'cbW*ctq8': 8.53662925237586e-07, 'cbW*ctlTi': -2.0443728487862245e-08, 'cbW*ctq1': -5.476086357703025e-07, 'cbW*ctli': 1.993984533044113e-08, 'cbW*cQq13': -2.612305252114311e-06, 'cbW*cbW': 1.0337896347045898, 'cpQM*sm': -0.7589057683944702, 'cpQM*cpt': -0.2652095556259155, 'cpQM*ctp': 0.14101937413215637, 'cpQM*cptb': -1.6367220467827792e-08, 'cpQM*cQlMi': -4.6736907677313866e-09, 'cpQM*cQq81': 0.005249772220849991, 'cpQM*cQq11': -0.1303834617137909, 'cpQM*cQl3i': -3.921678093377068e-09, 'cpQM*ctq8': -0.0016502946382388473, 'cpQM*ctlTi': -4.554415955482227e-09, 'cpQM*ctq1': -0.22192512452602386, 'cpQM*ctli': 2.746852079127393e-09, 'cpQM*cQq13': -1.4882029294967651, 'cpQM*cbW': -1.9433994680184696e-07, 'cpQM*cpQM': 0.3750135600566864, 'cpQ3*sm': 1.044708251953125, 'cpQ3*cpt': 0.013764224015176296, 'cpQ3*ctp': -0.37276342511177063, 'cpQ3*cptb': -1.0615155865423276e-08, 'cpQ3*cQlMi': 1.5244769002720204e-08, 'cpQ3*cQq81': 1.6736324326416252e-08, 'cpQ3*cQq11': 1.8043394902633736e-06, 'cpQ3*cQl3i': -1.2654279402113389e-08, 'cpQ3*ctq8': 2.0914319520670688e-06, 'cpQ3*ctlTi': -1.7030192367428754e-08, 'cpQ3*ctq1': -3.6383469250722555e-06, 'cpQ3*ctli': -1.6365824251352024e-08, 'cpQ3*cQq13': 3.220631015210529e-06, 'cpQ3*cbW': -7.69842145587063e-08, 'cpQ3*cpQM': 0.23637834191322327, 'cpQ3*cpQ3': 1.4034578800201416, 'ctei*sm': -3.4474012977625534e-08, 'ctei*cpt': 5.512284517728006e-10, 'ctei*ctp': 4.456057567381322e-08, 'ctei*cptb': -6.200062685479679e-10, 'ctei*cQlMi': -7.448415773048112e-10, 'ctei*cQq81': 1.833287655017557e-08, 'ctei*cQq11': -3.295008355053142e-08, 'ctei*cQl3i': -6.482242520533532e-10, 'ctei*ctq8': 3.447473417850233e-08, 'ctei*ctlTi': -6.155672638286092e-10, 'ctei*ctq1': -9.495918362745215e-08, 'ctei*ctli': 7.758654274603316e-10, 'ctei*cQq13': -1.1334127947293382e-07, 'ctei*cbW': -6.905018778979866e-10, 'ctei*cpQM': -8.208306923052078e-09, 'ctei*cpQ3': -1.225019374828662e-08, 'ctei*ctei': 1.525440662675237e-09, 'cQei*sm': 6.310612832294282e-08, 'cQei*cpt': -6.710165756373954e-09, 'cQei*ctp': 1.0958887131096162e-08, 'cQei*cptb': 6.511432282252372e-09, 'cQei*cQlMi': -3.6286743054780857e-10, 'cQei*cQq81': 4.703142408857275e-08, 'cQei*cQq11': 7.01613842579718e-08, 'cQei*cQl3i': 1.823055595373546e-10, 'cQei*ctq8': 5.972788930108663e-09, 'cQei*ctlTi': -6.125061569051127e-10, 'cQei*ctq1': -3.770812995185224e-08, 'cQei*ctli': 5.346649165072215e-11, 'cQei*cQq13': 1.1575740188618511e-07, 'cQei*cbW': 3.08702796658622e-09, 'cQei*cpQM': -2.414677791051645e-09, 'cQei*cpQ3': 1.4314583296481942e-08, 'cQei*ctei': -4.526716224084737e-10, 'cQei*cQei': 7.627079523508939e-10, 'ctW*sm': 10.60129165649414, 'ctW*cpt': -0.6542640328407288, 'ctW*ctp': -0.6008167862892151, 'ctW*cptb': -2.594395311916742e-07, 'ctW*cQlMi': 5.843355666002026e-08, 'ctW*cQq81': -0.314859539270401, 'ctW*cQq11': 19.91262435913086, 'ctW*cQl3i': 1.0284473006549888e-07, 'ctW*ctq8': 0.32443520426750183, 'ctW*ctlTi': 1.9665247208422443e-08, 'ctW*ctq1': 19.729764938354492, 'ctW*ctli': -7.701803639292848e-08, 'ctW*cQq13': 38.24192428588867, 'ctW*cbW': -3.0828800845483784e-07, 'ctW*cpQM': -0.6596970558166504, 'ctW*cpQ3': -0.41626399755477905, 'ctW*ctei': 1.1084462236965464e-08, 'ctW*cQei': -3.361735068097005e-08, 'ctW*ctW': 46.1742057800293, 'ctlSi*sm': 5.400481839501481e-09, 'ctlSi*cpt': 6.856188061732382e-09, 'ctlSi*ctp': 3.111382795850659e-08, 'ctlSi*cptb': 1.1483544115620248e-09, 'ctlSi*cQlMi': 6.944966823851928e-10, 'ctlSi*cQq81': 3.768840528550754e-08, 'ctlSi*cQq11': -3.751082999770006e-08, 'ctlSi*cQl3i': 3.8924324874400895e-10, 'ctlSi*ctq8': 9.48215372886807e-08, 'ctlSi*ctlTi': -1.8774502785756653e-10, 'ctlSi*ctq1': 2.28214659614423e-07, 'ctlSi*ctli': 5.137687497658305e-10, 'ctlSi*cQq13': -7.103921717543926e-08, 'ctlSi*cbW': 6.21984597160008e-09, 'ctlSi*cpQM': -5.4936353244272595e-09, 'ctlSi*cpQ3': -6.794911744378851e-09, 'ctlSi*ctei': -1.1628050744505458e-09, 'ctlSi*cQei': 5.939108926877879e-11, 'ctlSi*ctW': -5.3417320344806285e-08, 'ctlSi*ctlSi': 3.716685292864952e-11, 'cQq83*sm': 7.974160671234131, 'cQq83*cpt': 0.014319781213998795, 'cQq83*ctp': -0.4949095547199249, 'cQq83*cptb': -6.380445825016068e-07, 'cQq83*cQlMi': -1.0406843387045228e-07, 'cQq83*cQq81': 9.015138626098633, 'cQq83*cQq11': -1.603721261024475, 'cQq83*cQl3i': -2.783344665857612e-09, 'cQq83*ctq8': 2.9018709659576416, 'cQq83*ctlTi': 1.7557431064574303e-08, 'cQq83*ctq1': -0.009971335530281067, 'cQq83*ctli': -2.09774100312643e-08, 'cQq83*cQq13': -6.615616321563721, 'cQq83*cbW': -8.278443601739127e-07, 'cQq83*cpQM': 0.05076571926474571, 'cQq83*cpQ3': -5.160800355952233e-07, 'cQq83*ctei': -3.469034837166873e-08, 'cQq83*cQei': 2.5472383313740465e-08, 'cQq83*ctW': -0.5884737372398376, 'cQq83*ctlSi': -1.3109291430168923e-08, 'cQq83*cQq83': 18.1739501953125, 'ctZ*sm': -5.602893352508545, 'ctZ*cpt': -0.3038504719734192, 'ctZ*ctp': 0.34167593717575073, 'ctZ*cptb': -7.203270797617733e-07, 'ctZ*cQlMi': 6.890596182529407e-08, 'ctZ*cQq81': 0.2056303769350052, 'ctZ*cQq11': -13.456686019897461, 'ctZ*cQl3i': 1.3353832173379487e-07, 'ctZ*ctq8': -0.22672522068023682, 'ctZ*ctlTi': 1.4900550127094903e-07, 'ctZ*ctq1': -13.521340370178223, 'ctZ*ctli': -4.934238262421786e-08, 'ctZ*cQq13': -2.3552284240722656, 'ctZ*cbW': 1.3300788168635336e-06, 'ctZ*cpQM': -0.28485724329948425, 'ctZ*cpQ3': 0.04291217029094696, 'ctZ*ctei': 1.7279806030501277e-08, 'ctZ*cQei': -1.0998268606954298e-07, 'ctZ*ctW': -63.81882858276367, 'ctZ*ctlSi': -7.185191464031959e-08, 'ctZ*cQq83': 0.03854534029960632, 'ctZ*ctZ': 31.869539260864258, 'ctG*sm': 536.4585571289062, 'ctG*cpt': 0.2940845489501953, 'ctG*ctp': -32.8100700378418, 'ctG*cptb': -6.74147031531902e-07, 'ctG*cQlMi': -6.187071335261862e-07, 'ctG*cQq81': 24.467735290527344, 'ctG*cQq11': -2.20035719871521, 'ctG*cQl3i': -1.9523839966950618e-07, 'ctG*ctq8': 26.1304988861084, 'ctG*ctlTi': -1.3151947086953442e-07, 'ctG*ctq1': 2.2028255462646484, 'ctG*ctli': 1.2641018543035898e-07, 'ctG*cQq13': -1.42359459400177, 'ctG*cbW': -9.525850146019366e-06, 'ctG*cpQM': -0.36530253291130066, 'ctG*cpQ3': -0.4938200116157532, 'ctG*ctei': 9.92381956166355e-07, 'ctG*cQei': -1.1255787057962152e-07, 'ctG*ctW': 4.186697483062744, 'ctG*ctlSi': -3.9445922084269114e-07, 'ctG*cQq83': 5.642223358154297, 'ctG*ctZ': -2.5790209770202637, 'ctG*ctG': 735.4454345703125}

    # Scale the WC fit dict to the SM
    wc_fit_dict = qft.scale_to_sm(wc_fit_dict)

    # Make 1d quad plots for all the WCs
    save_dir_path = "/afs/crc.nd.edu/user/k/kmohrman/www/EFT/TopCoffea/testing/Sep5_00"
    yaxis_str = "$\sigma/\sigma_{SM}$"
    for wc_name in wc_names_lst:
        fit_coeffs_1d = qft.get_1d_fit(wc_fit_dict,wc_name)
        xaxis_lims = qft.ARXIV1901_LIMS.get(wc_name,qft.TOP19001_LIMS.get(wc_name,[-10,10])) # Use lim from 1901 theory paper if it exists, or TOP-19-001 if it exists, or -10,10 otherwise
        qft.make_1d_quad_plot(
            fit_coeffs_1d,
            wc_name,
            yaxis_str,
            title=wc_name,
            xaxis_range = xaxis_lims,
            save_dir=save_dir_path,
        )

    make_html(save_dir_path)


if __name__ == "__main__":
    main()
